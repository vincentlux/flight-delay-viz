<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
    <title>How should I fly?</title>
    
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>

    <!-- Core CSS     -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/paper-dashboard.css" rel="stylesheet"/>

    <!--  Fonts and icons     -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
    <link href="assets/css/themify-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

</head>
<body>

<div class="wrapper">
    <div class="sidebar" data-background-color="white">

    	<div class="sidebar-wrapper">
            <div class="logo">
                <a class="simple-text" href="index.html">
                    HOW SHOULD I FLY?
                </a>
            </div>
            <div class="nav">
                <form>
                    
                    <div style="background-color:#D9D9D9; border-radius: 12px">
                        <p style="font-size:16px; line-height:3; text-align: center;  margin-top: 20px">Departure</p>
        
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: right">
                            <!-- dropdown menu for departure state -->
                            <select name="departure_state" id="departure_state" onChange="changeDepAirport(this.value);" style="width:100%; padding: 10px; border-radius: 10px"></select>
                        </p>
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: right">
                            <!-- dropdown menu for departure airport, generated by choice of state -->
                            <select name="departure_airport" id="departure_airport" style="width:100%; padding: 10px; margin-bottom: 50px; border-radius: 10px">
                                <option value="" disabled selected>Select an airport</option>
                            </select>
                        </p>
                    </div>
                    <!-- adapted from https://stackoverflow.com/questions/30232146/dynamically-populating-drop-down-list-from-selection-of-another-drop-down-value -->
                    <div style="background-color:rgb(228, 228, 228); border-radius: 12px">
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: center; background-color:rgb(228, 228, 228); margin-top: 15px">Arrival</p>
    
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: right">
                            <!-- dropdown menu for arrival state -->
                            <select name="arrival_state" id="arrival_state" onChange="changeArrivAirport(this.value);" style="width:100%; padding: 10px; border-radius: 10px"></select>
                        </p>
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: right">
                            <!-- dropdown menu for arrival airport, generated by choice of state -->
                            <select name="arrival_airport" id="arrival_airport" style="width:100%; padding: 10px; margin-bottom: 50px; border-radius: 10px">
                                <option value="" disabled selected>Select an airport</option>
                            </select>
                        </p>
                    </div>
    
                    
    
                    <!-- submit button for the departure and arrival parameters, which will visualize the data for that route -->
                    <p style="padding-left: 25px">
                        <!-- <button name="go" id="go" type="submit" onclick="retrieveRouteData()">Go!</button> -->
                        <input name="go" id="go" type="submit" onclick="retrieveRouteData()" style="font-size:20px; line-height:2; margin: 10px; text-align: center; background-color:rgba(171, 148, 83, 0.692); color: #373F27; width: 80%; border: 1em; border-color: black; border-radius: 10px">
                    </p>
                </form>
            </div>
        </div>
    </div>

    <div class="main-panel">
        <nav class="navbar navbar-default" style="background-color:#99bedd85">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar bar1"></span>
                        <span class="icon-bar bar3"></span>
                    </button>
                    <a class="navbar-brand">Flight Dashboard</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="dashboard.html">
                                <i class="ti-panel" style="color:#062f4f"></i>
								<p style="color:#062f4f">Severity of Delay</p>
                            </a>
                        </li>
						<li>
                            <a href="reasons.html" style="margin-left:30px; margin-right:30px">
								<i class="ti-settings" style="color:#6d7993"></i>
								<p style="color:#6d7993">Cause of Delay</p>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

<!-- HEATMAP -->
        <div class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card" style="margin-top:30px">
                            <div class="header">
                                <h4 class="title" style="font-weight:bold">Flight Delay Severity</h4>
                                <p class="category" style="font-weight:bold">24 Hours / 7 Days Performance</p>
                            </div>
                            <div class="content">
                                <div id="heatmap" style="margin-left: 20px"></div>
                                <div class="footer">
                                    <div class="chart-legend" style="margin-top:35px; font-size: 120%">
                                        <span style="color:red; margin-left: 200px;margin-right: 20px">
                                            <i class="fas fa-square"></i> Less than 0
                                        </span>
                                        <span style="color:rgb(255, 136, 0); margin-right: 20px">
                                            <i class="fas fa-square"></i> 0 - 15
                                        </span>
                                        <span style="color:rgb(255, 208, 0); margin-right: 20px">
                                            <i class="fas fa-square"></i> 15 - 30
                                        </span>
                                        <span style="color:rgb(110, 179, 7); margin-right: 20px">
                                            <i class="fas fa-square"></i> 30 - 45
                                        </span>
                                        <span style="color:green"; margin-right: 20px>
                                            <i class="fas fa-square"></i> More than 45
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

    <script type="text/javascript">


        // References
        // http://bl.ocks.org/PBrockmann/raw/635179ff33f17d2d75c2/
        // http://bl.ocks.org/tjdecke/raw/5558084/

        // ===============================================================
        // Define initial tooltip.
        // var tooltip = d3.select(origin)
        //     .append("div")
        //     .style("position", "absolute")
        //     .style("visibility", "hidden");

        // ===============================================================
        // Define display property.
        var margin = { top: 50, right: 0, bottom: 100, left: 50 };
        var width = 920 - margin.left - margin.right;
        var height = 310 - margin.top - margin.bottom;
        var gridSize = Math.floor(width / 24);
        var legendElementWidth = gridSize * 2;
        
        var buckets = 5;
        var colors = ["#008000", "#6EB307", "#FFD000", "#FF8800", "#FF0000"];


        // ===============================================================
        // Define days and hours attributes.
        var days = ["MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"];
        var hours = ["00", "01", "02", "03", "04", "05", "06", "07",
                    "08", "09", "10", "11", "12", "13", "14", "15",
                    "16", "17", "18", "19", "20", "21", "22", "23"];

        // Define TEST data array.
        var data = [
            {DayOfWeek:2, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: -3.0},
            {DayOfWeek:2, Origin: "CLT", Dest: "PHX", CRSDepTime: "204", DepDelay: 0.0},
            {DayOfWeek:2, Origin: "CLT", Dest: "PHX", CRSDepTime: "1", DepDelay: 5.0},
            {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: -10.0},
            {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: 20.0},
            {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: 24.0},
            {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: 7.0},
            {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "2359", DepDelay: 10.0},
            {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "1820", DepDelay: 35.0},
            {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "830", DepDelay: 2.0},
            {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "2250", DepDelay: -8.0},
            {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "0655", DepDelay: 9.0},
            {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 52.0},
            {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 1.0},
            {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: -2.0},
            {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 8.0},
            {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 36.0},
            {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 17.0},
            {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 28.0},
            {DayOfWeek:6, Origin: "CLT", Dest: "PHX", CRSDepTime: "1815", DepDelay: 0.0},
            {DayOfWeek:6, Origin: "CLT", Dest: "PHX", CRSDepTime: "1900", DepDelay: 8.0},
            {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1440", DepDelay: 90.0},
            {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1440", DepDelay: 48.0},
            {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1540", DepDelay: 33.0},
            {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1540", DepDelay: 9.0},
            {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: -12.0},
            {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 0.0},
            {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 26.0},
            {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 6.0},
            {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: -1.0}
        ];
        // console.log(data);


        // ===============================================================
        // Convert CRSDepTime data into 4 digits ("1" -> "0001").
        function pad_with_zeroes(CRSDepTime) {

            var my_string = '' + CRSDepTime;
            while (my_string.length < 4) {
                my_string = '0' + my_string;
            }
            return my_string;
        }
        // Call the function to update the original data.
        data.forEach(function(d){
            d.CRSDepTime =  pad_with_zeroes(d.CRSDepTime)
        });
        

        // References
        // http://learnjsdata.com/group_data.html

        // ===============================================================
        // Group data based on DayOfWeek and updated CRSDepTime (DepHour).
        // Calculate the average DepDelay for each group of data.
        var arrayNested = d3.nest()
            .key(function(d) {return d.DayOfWeek;})
            .key(function(d) {return d.CRSDepTime.substring(0,2);})
            .rollup(function(d) {return d3.mean(d, function(s) {return s.DepDelay;});})
            .entries(data)
            .map(function(subgroup) {
                return {
                    DayOfWeek: subgroup.key,
                    Time: subgroup.values.map(function (d) {
                        return {CRSDepTime: d.key,
                                avgDepDelay: d.value}       
                    })
                }
            });
        // console.log(JSON.stringify(arrayNested));
        


        // ===============================================================
        // Create the SVG canvas that will be used to render the visualization.
        var svg = d3.select("#heatmap")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        var borderPath = svg.append("rect")
            .attr("x", -1)
            .attr("y", -1)
            .attr("rx", 6)
            .attr("ry", 6)
            .attr("height", 254)
            .attr("width", width-4)
            .style("stroke", "darkgrey")
            .style("stroke-width", "2")
            .style("fill", "none");

        // ===============================================================
        // Create hourLabels for x-axis and dayLabels for y-axis.
        var hourLabels = svg.append("g")
            .attr("class", "hourLabels")
            .selectAll(".hourLabel")
            .data(hours)
            .enter().append("text")
                .text(function(d) { return d; })
                .attr("x", 0)
                .attr("y", function(d, i) {
                    return i * gridSize;
                })
                .style("text-anchor", "middle")
                .style("font-size", "120%")
                .style("font-weight", "bold")
                .attr("transform", function(d, i) {
                    return "translate(" + gridSize / 2 + ", -3) " +
                            "rotate(-90) " +
                            "rotate(90, 0, " + (i * gridSize) + ")"
                });

        var dayLabels = svg.append("g")
            .attr("class", "dayLabels")
            .selectAll(".dayLabel")
            .data(days)
            .enter().append("text")
            .text(function (d) { return d; })
            .attr("x", 0)
            .attr("y", function (d, i) {
                return i * gridSize;
            })
            .style("text-anchor", "end")
            .style("font-size", "120%")
            .style("font-weight", "bold")
            .attr("transform", "translate(-3," + gridSize / 1.5 + ")");

        // var xScale = d3.scaleLinear()
        //     .domain([-width / 2, width / 2])
        //     .range([0, width]);
    
        // // we'll do the same thing for the y axis except the positive values start from the top with height first in the range
        // // this allows us to have all positive coordinates (e.g [2,2]) in the top right hand corner.
        // var yScale = d3.scaleLinear()
        //     .domain([-height/2, height / 2])
        //     .range([height, 0]);
        // // this allows us to configure our axis and frequency of the lines in th grid,
        // // notice the tick size streteches the length of the canvas. 
        // var xAxis = d3.axisBottom(xScale)
        //     .ticks(24)
        //     .tickSize(height + margin.top + margin.bottom);
        // var yAxis = d3.axisRight(yScale)
        //     .ticks(7)
        //     .tickSize(width);
        //     // finally we can append our axis onto an svg group tag. 
        // gX = svg.append("g")
        //     .attr("class", "axis axis--x")
        //     .call(xAxis);
        // gY = svg.append("g")
        //     .attr("class", "axis axis--y")
        //     .call(yAxis);

        // ===============================================================
        // Get flattened data {DayOfWeek: "2", CRSDepTime: "16", avgDepDelay: -3}
        var flattened = [];
        arrayNested.forEach(function(day) {
            day.Time.forEach(function(CRSDepTime) {
                flattened.push({
                    DayOfWeek: day.DayOfWeek,
                    CRSDepTime: CRSDepTime.CRSDepTime,
                    avgDepDelay: CRSDepTime.avgDepDelay
                });
            });
        });

        // input should be flattened
        flattened.forEach(function(d) {
            DayOfWeek = +d.DayOfWeek,
            CRSDepTime = +d.CRSDepTime,
            avgDepDelay = +d.avgDepDelay
        });
        // console.log(flattened)
        
            
        // ===============================================================
        // Render heatmap. 
        var heatmapChart = function(data) {
            
            var cards = svg.selectAll(".CRSDepTime")
                .data(data, function(d) {return d.DayOfWeek+':'+d.CRSDepTime;});

            cards.append("title");

            cards.enter().append("rect")
                .attr("x", function(d) { return (d.CRSDepTime) * gridSize; })
                .attr("y", function(d) { return (d.DayOfWeek-1) * gridSize; })
                .attr("rx", 4)      // define the radius of the ellipse used to 
                .attr("ry", 4)      // round off the corners of the rectangle.
                .attr("class", "hour bordered")
                .attr("width", gridSize)
                .attr("height", gridSize)
                .style("fill", function(d) { 
                    if (d.avgDepDelay <= 0) {
                        return colors[0];
                    } else if (d.avgDepDelay <= 15) {
                        return colors[1];
                    } else if (d.avgDepDelay <= 30) {
                        return colors[2];
                    } else if (d.avgDepDelay <= 45) {
                        return colors[3];
                    } else {
                        return colors[4];
                    }
                    
                    });

            cards.select("title").text(function(d) { return d.avgDepDelay; });
            
            cards.exit().remove();
        }
        heatmapChart(flattened);
        
    </script>

</html>
