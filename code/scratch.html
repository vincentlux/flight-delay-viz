<!DOCTYPE html>
<html>
<head>
    <title>Flight Delay Heatmap</title>
    <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <style>

    </style>
</head>

<body>

<h1>Flight Delay Heatmap</h1>
<div id="heatmap"></div>
    <script type="text/javascript">

        //function heatmap_display(url, origin, destination) {

            // References
            // http://bl.ocks.org/PBrockmann/raw/635179ff33f17d2d75c2/
            // http://bl.ocks.org/tjdecke/raw/5558084/

            // ===============================================================
            // Define initial tooltip.
            var tooltip = d3.select(origin)
                .append("div")
                .style("position", "absolute")
                .style("visibility", "hidden");

            // ===============================================================
            // Define display property and color scheme.
            var margin = { top: 50, right: 0, bottom: 100, left: 50 };
            var width = 960 - margin.left - margin.right;
            var height = 430 - margin.top - margin.bottom;
            var gridSize = Math.floor(width / 24);
            var legendElementWidth = gridSize * 2;
            var buckets = 5;    // refers to five color selections
            var colors = ["#ffffd9","#c7e9b4","#41b6c4","#225ea8","#253494"];

            // ===============================================================
            // Define days and hours attributes.
            var days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
            var hours = ["1", "2", "3", "4", "5", "6", "7", "8", "9",
                        "10", "11", "12", "13", "14", "15", "16", "17",
                        "18", "19", "20", "21", "22", "23", "24"];

            // Define TEST data array.
            var data = [
                {DayOfWeek:2, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: -3.0},
                {DayOfWeek:2, Origin: "CLT", Dest: "PHX", CRSDepTime: "204", DepDelay: 0.0},
                {DayOfWeek:2, Origin: "CLT", Dest: "PHX", CRSDepTime: "1", DepDelay: 5.0},
                {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: -10.0},
                {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: 20.0},
                {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: 24.0},
                {DayOfWeek:3, Origin: "CLT", Dest: "PHX", CRSDepTime: "1619", DepDelay: 7.0},
                {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "2359", DepDelay: 10.0},
                {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "1820", DepDelay: 35.0},
                {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "830", DepDelay: 2.0},
                {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "2250", DepDelay: -8.0},
                {DayOfWeek:4, Origin: "CLT", Dest: "PHX", CRSDepTime: "0655", DepDelay: 9.0},
                {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 52.0},
                {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 1.0},
                {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: -2.0},
                {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 8.0},
                {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 36.0},
                {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 17.0},
                {DayOfWeek:5, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 28.0},
                {DayOfWeek:6, Origin: "CLT", Dest: "PHX", CRSDepTime: "1815", DepDelay: 0.0},
                {DayOfWeek:6, Origin: "CLT", Dest: "PHX", CRSDepTime: "1900", DepDelay: 8.0},
                {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1440", DepDelay: 20.0},
                {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1440", DepDelay: 48.0},
                {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1540", DepDelay: 33.0},
                {DayOfWeek:7, Origin: "CLT", Dest: "PHX", CRSDepTime: "1540", DepDelay: 9.0},
                {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: -12.0},
                {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 0.0},
                {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 26.0},
                {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: 6.0},
                {DayOfWeek:1, Origin: "CLT", Dest: "PHX", CRSDepTime: "1230", DepDelay: -1.0}
            ];
            // console.log(data);
            // To convert "1" -> "0001"
            function pad_with_zeroes(CRSDepTime) {

                var my_string = '' + CRSDepTime;
                while (my_string.length < 4) {
                    my_string = '0' + my_string;
                }
                return my_string;
            }
            // update the original data
            data.forEach(function(d){d.CRSDepTime =  pad_with_zeroes(d.CRSDepTime)})
            
            // refer to http://learnjsdata.com/group_data.html
            
            var arrayNested = d3.nest()
                            .key(function(d) {return d.DayOfWeek;})
                            .key(function(d) {return d.CRSDepTime.substring(0,2);})
                            .rollup(function(d) {return d3.mean(d, function(s) {return s.DepDelay;});})
                            .entries(data)
                            .map(function(subgroup) {
                                return {
                                DayOfWeek:subgroup.key,
                                Time:subgroup.values.map(function(d) {return [{CRSDepTime:d.key, avgDepDelay:d.value}]})
                                }
                            // .map(function(subgroup) {
                            //     return {
                            //     DayOfWeek:subgroup.key,
                            //     Time:subgroup.values,
                            //     TimeDistr: subgroup.values.map(function(d) {return d.key}),
                            //     CRSDepTime:subgroup.values.map(function(d) {return d.value})
                            //     }
                            });
            
            console.log(JSON.stringify(arrayNested));    




            // ===============================================================
            // Create the SVG canvas that will be used to render the visualization.
            var svg = d3.select("#heatmap")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");



            var dayLabels = svg.append("g")
                .attr("class", "dayLabels")
                .selectAll(".dayLabel")
                .data(days)
                .enter().append("text")
                    .text(function (d) { return d; })
                    .attr("x", 0)
                    .attr("y", function (d, i) {
                        return i * gridSize;
                    })
                    .style("text-anchor", "end")

                    // https://www.dashingd3js.com/svg-group-element-and-d3js
                    // nested transforms are applied from right to left
                    .attr("transform", "translate(-3," + gridSize / 1.5 + ")");


            var timeLabels = svg.append("g")
                .attr("class", "timeLabels")
                .selectAll(".timeLabel")
                .data(hours)
                .enter().append("text")
                    .text(function(d) { return d; })
                    .attr("x", 0)
                    .attr("y", function(d, i) {
                        return i * gridSize;
                    })
                    .style("text-anchor", "middle")
                    .attr("transform", function(d, i) {
                        return "translate(" + gridSize / 2 + ", -3) " +
                                "rotate(-90) " +
                                "rotate(45, 0, " + (i * gridSize) + ")"
                    })

            var row = svg.selectAll(".row")
                .data(depHour)
                .enter().append("g")
                .attr("id",  function(d) { return d; })
                .attr("class", "row");

            var j = 0;
            var heatMap = row.selectAll(".cell")
                .data(function(d) {
                    j++;
                    return d;
                })
                .enter().append("")

        // }






/*


        // NOT tsvFile!! change that
        var heatmapChart = function(tsvFile) {
            d3.tsv(tsvFile,
                function(d) {
                    return {
                        day: +d.day,
                        hour: +d.hour,
                        value: +d.value
                    };
                },
                function(error, data) {
                    var colorScale = d3.scale.quantile()
                        .domain([0, buckets - 1, d3.max(data, function (d) { return d.value; })])
                        .range(colors);

                    var cards = svg.selectAll(".hour")
                        .data(data, function(d) {return d.day+':'+d.hour;});

                    cards.append("title");

                    cards.enter().append("rect")
                        .attr("x", function(d) { return (d.hour - 1) * gridSize; })
                        .attr("y", function(d) { return (d.day - 1) * gridSize; })
                        .attr("rx", 4)
                        .attr("ry", 4)
                        .attr("class", "hour bordered")
                        .attr("width", gridSize)
                        .attr("height", gridSize)
                        .style("fill", colors[0]);

                    cards.transition().duration(1000)
                        .style("fill", function(d) { return colorScale(d.value); });

                    cards.select("title").text(function(d) { return d.value; });

                    cards.exit().remove();

                    var legend = svg.selectAll(".legend")
                        .data([0].concat(colorScale.quantiles()), function(d) { return d; });

                    legend.enter().append("g")
                        .attr("class", "legend");

                    legend.append("rect")
                        .attr("x", function(d, i) { return legendElementWidth * i; })
                        .attr("y", height)
                        .attr("width", legendElementWidth)
                        .attr("height", gridSize / 2)
                        .style("fill", function(d, i) { return colors[i]; });

                    legend.append("text")
                        .attr("class", "mono")
                        .text(function(d) { return "≥ " + Math.round(d); })
                        .attr("x", function(d, i) { return legendElementWidth * i; })
                        .attr("y", height + gridSize);

                    legend.exit().remove();

                });
        };


        heatmapChart(datasets);

        var datasetpicker = d3.select("#dataset-picker").selectAll(".dataset-button")
            .data(datasets);

        datasetpicker.enter()
            .append("input")
            .attr("value", function(d){ return "Dataset " + d })
            .attr("type", "button")
            .attr("class", "dataset-button")
            .on("click", function(d) {
                heatmapChart(d);
            });
*/


    </script>

</body>
</html>