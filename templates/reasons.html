<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
    <title>How should I fly?</title>
    
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <!-- Core CSS     -->
    <link href="http://0.0.0.0:5000/static/assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="http://0.0.0.0:5000/static/assets/css/paper-dashboard.css" rel="stylesheet"/>
    <link href="http://0.0.0.0:5000/static/assets/css/themify-icons.css" rel="stylesheet"/>

    <!--  Fonts and icons     -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
<style>

.chart-wrapper {
	width: 850px;
	height: 550px;
	margin: auto;
	background-color: #FAF7F7;
}

.chart-wrapper2 {
	width: 950px;
	height: 450px;
	margin: auto;
	background-color: #FAF7F7;
}

.chart-wrapper .inner-wrapper {
	position: relative;
	padding-bottom: 50%;
	width: 100%;
}

.chart-wrapper .outer-box {
	position: absolute;
	top: 0; bottom: 0; left: 0; right: 0;
}

.chart-wrapper .inner-box {
	width: 100%;
	height: 100%;
}

.chart-wrapper text {
	font-family: sans-serif;
    font-size: 16px;
}

.chart-wrapper p {
	font-size: 16px;
	margin-top:5px;
	margin-bottom: 40px;
}

.chart-wrapper .axis path,
.chart-wrapper .axis line {
	fill: none;
	stroke: #1F1F2E;
	stroke-opacity: 0.9;
	shape-rendering: crispEdges;
}
.chart-wrapper .axis path {
	stroke-width: 5px;
}

.chart-wrapper .line {
	fill: none;
	stroke: steelblue;
	stroke-width: 6px;
}

.chart-wrapper .legend  {
	min-width: 200px;
	display: flex;
	justify-content: flex-start;
	flex-wrap: wrap;
	font-size: 16px;
    padding-top: 10px;
    padding-left: 20px;
}
.chart-wrapper .legend > div {
	margin: 75px 25px 0px 10px;
	flex-grow: 0;
}
.chart-wrapper .legend p {
	display:inline;
	font-size: 1em;
	font-family: sans-serif;
    font-weight: 600;
}
.chart-wrapper .legend .series-marker {
	height: 1em;
	width: 1em;
	border-radius: 35%;
	background-color: crimson;
	display: inline-block;
	margin-right: 4px;
	margin-bottom: -0.16rem;
}

.chart-wrapper .overlay {
	fill: none;
	pointer-events: all;
}

.chart-wrapper .focus circle {
	fill: crimson;
	stroke: crimson;
	stroke-width: 2px;
	fill-opacity: 15%;
}
.chart-wrapper .focus rect {
	fill: rgb(97, 162, 184);
	opacity: 0.4;
    border-radius: 2px;
    width: 2.8em;
}
.chart-wrapper .focus.line {
	stroke: steelblue;
	stroke-dasharray: 5,5;
	stroke-width: 4;
	opacity: 0.5;
}
.chart-wrapper .focus text {
    font-size: 140%;
    fill:rgb(51, 51, 51);
}
@media (max-width:500px){
	.chart-wrapper .line {stroke-width: 3px;}
	.chart-wrapper .legend {font-size: 14px;}
}
rect.bordered {
	stroke: darkgray;
	stroke-width:2px;   
}
</style>

</head>
<body>

<div class="wrapper">
    <div class="sidebar" data-background-color="white">

    	<div class="sidebar-wrapper">
            <div class="logo">
                <a class="simple-text" href="/">
                    HOW SHOULD I FLY?
                </a>
            </div>
            <div class="nav">
                <form>
                    
                    <div style="background-color:#D9D9D9; border-radius: 12px; margin-top:100px">
                        <p style="font-size:16px; line-height:3; text-align: center;  margin-top: 20px">Year</p>
        
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: right">
                            <select name="year" id="year" style="width:100%; padding: 10px; margin-bottom: 50px; border-radius: 10px">
                                <option value="" disabled selected>Select a year</option>
                                <option value="2013">2013</option>
                                <option value="2014">2014</option>
                                <option value="2015">2015</option>
                                <option value="2016">2016</option>
                                <option value="2017">2017</option>
                            </select>
                        </p>
                    </div>
                    
                    <div style="background-color:rgb(228, 228, 228); border-radius: 12px">
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: center; background-color:rgb(228, 228, 228); margin-top: 30px">Carrier</p>
    
                        <p style="font-size:16px; line-height:3; margin:10px; text-align: right">
                            <select name="carrier" id="carrier" style="width:100%; padding: 10px; margin-bottom: 50px; border-radius: 10px">
                                <option value="" disabled selected>Select a carrier</option>
                                <option value="AS">Alaska Airlines (AS)</option>
                                <option value="AA">American Airlines (AA)</option>
                                <option value="EV">Atlantic Southeast Airlines (EV)</option>
                                <option value="DL">Delta Airlines (DL)</option>
                                <option value="F9">Frontier Airlines (F9)</option>
                                <option value="HA">Hawaiian Airlines (HA)</option>
                                <option value="B6">JetBlue Airlines (B6)</option>
                                <option value="OO">SkyWest Airlines (OO)</option>
                                <option value="WN">Southwest Airlines (WN)</option>
                                <option value="NK">Spirit Airlines (NK)</option>
                                <option value="UA">United Airlines (UA)</option>
                                <option value="VX">Virgin America (VX)</option>
                            </select>
                        </p>
                    </div>
    
                    <p style="padding-left: 25px; margin-top: 20px">
                        <input name="go" id="go" type="submit" onclick="retrieveData()" style="font-size:20px; line-height:2; margin: 10px; text-align: center; background-color:rgba(171, 148, 83, 0.692); color: #373F27; width: 80%; border: 1em; border-color: black; border-radius: 10px">
                    </p>
                </form>
            </div>
        </div>
    </div>

    <div class="main-panel">
        <nav class="navbar navbar-default" style="background-color:#99bedd85">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar bar1"></span>
                        <span class="icon-bar bar3"></span>
                    </button>
                    <a class="navbar-brand" href="/">Flight Dashboard</a>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/dashboard">
                                <i class="ti-panel" style="color:#6d7993"></i>
								<p style="color:#6d7993">Severity of Delay</p>
                            </a>
                        </li>
						<li>
                            <a href="/reasons" style="margin-left:30px; margin-right:30px">
								<i class="ti-settings" style="color:#062f4f"></i>
								<p style="color:#062f4f">Cause of Delay</p>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

<!-- LINECHART -->
        <div class="content" style="padding-top:30px; padding-bottom: 10px">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="header">
                                <h4 class="title" style="font-weight:bold">Flight Delay Reasons</h4>
                                <p class="category" style="font-weight:bold">12 Carriers / 5 Years Performance</p>
                            </div>
                            <div class="content">
                                <div class="chart">
                                    <div class="chart-wrapper" id="chart-line1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script type="text/javascript">

    // Reference
    // http://bl.ocks.org/asielen/44ffca2877d0132572cb

    // =====================================================================================

    var data = (function() {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "http://0.0.0.0:5000/static/LineChartFull.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })();     


        dataGetReady(data);
        
        function dataGetReady(data){
            var oneDigit = d3.format(".1f");
            
            data.forEach(function(d) {
                AvgCarrierDelay = +d.AvgCarrierDelay,
                AvgWeatherDelay = +d.AvgWeatherDelay,
                AvgNASDelay = +d.AvgNASDelay,
                AvgSecurityDelay = +d.AvgSecurityDelay,
                AvgLateAircraftDelay = +d.AvgLateAircraftDelay,
                Year = +d.Year,
                FlightDate = +d.FlightDate,
                UniqueCarrier = +d.UniqueCarrier
            });

            data.forEach(function(d) {
                d.AvgCarrierDelay = oneDigit(d.AvgCarrierDelay),
                d.AvgWeatherDelay = oneDigit(d.AvgWeatherDelay),
                d.AvgNASDelay = oneDigit(d.AvgNASDelay),
                d.AvgSecurityDelay = oneDigit(d.AvgSecurityDelay),
                d.AvgLateAircraftDelay = oneDigit(d.AvgLateAircraftDelay),
                d.FlightDate = d.FlightDate.substring(5).replace("-","")
            });

            data.forEach(function(d) {
                if (d.FlightDate.substring(0,2) == "01") {
                    d.FlightDate = parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "02") {
                    d.FlightDate = 31 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "03") {
                    d.FlightDate = 60 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "04") {
                    d.FlightDate = 91 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "05") {
                    d.FlightDate = 121 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "06") {
                    d.FlightDate = 152 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "07") {
                    d.FlightDate = 182 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "08") {
                    d.FlightDate = 213 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "09") {
                    d.FlightDate = 244 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "10") {
                    d.FlightDate = 274 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "11") {
                    d.FlightDate = 305 + parseInt(d.FlightDate.substring(2));
                } else if (d.FlightDate.substring(0,2) == "12") {
                    d.FlightDate = 335 + parseInt(d.FlightDate.substring(2));
                }
            })
        };

        function retrieveData() {
            $("#chart-line1").empty();
            year = document.getElementById("year").value;
            carrier = document.getElementById("carrier").value;

            line_object = { 'year' : year,
                            'carrier' : carrier};
            console.log
            $(document).ready(function() {
                        $('form').submit(function (e) {
                            // e.preventDefault();
                            var url = "{{ url_for('fakeline') }}"; // send the data here
                            if (e.handled !== true){
                                e.handled = true // supress multiple posts
                                $.ajax({
                                type: "POST",
                                url: url,
                                data: JSON.stringify(line_object), // whatever inside route_object will be sent to /router
                                contentType: "application/json;charset=utf-8",
                                success: function (local_data) {
                                    console.log(local_data)
                                    get(local_data);
                                    // console.log(data);  // display the returned data in the console.
                                }
                            });
                            }

                            e.preventDefault(); // block the traditional submission of the form.
                        });
                    });

            var year;
            var carrier;
            function get(local_data){ // callback
                year = local_data.year;
                carrier = local_data.carrier;
            }

            var wantedData = data.filter(function(d) {

                return (d.Year == year) && (d.UniqueCarrier == carrier);
            });
            wantedData.sort(function(x,y) {
                return d3.ascending(x.FlightDate, y.FlightDate);
            })
            console.log(wantedData); 

            // =================================================================================================
            var chart = makeLineChart(wantedData, 
                                    'FlightDate', 
                                    {'Carrier Delay': {column: 'AvgCarrierDelay'},
                                    'Weather Delay': {column: 'AvgWeatherDelay'},
                                    'NAS Delay': {column: 'AvgNASDelay'},
                                    'Security Delay': {column: 'AvgSecurityDelay'},
                                    'Late Aircraft Delay': {column: 'AvgLateAircraftDelay'}}, 
                                    {xAxis: 'Dates', yAxis: 'Severity of Delay (minutes)'}
                                );
            
            chart.bind("#chart-line1");
            chart.render();
        };
    

        function makeLineChart(dataset, xName, yObjs, axisLables) {
            var chartObj = {};
            var color = d3.scale.category10();
            chartObj.xAxisLable = axisLables.xAxis;
            chartObj.yAxisLable = axisLables.yAxis;
            chartObj.data = dataset;
            chartObj.margin = {top: 15, right: 60, bottom: 30, left: 100};
            chartObj.width = 800 - chartObj.margin.left - chartObj.margin.right;
            chartObj.height = 480 - chartObj.margin.top - chartObj.margin.bottom;

            // So we can pass the x and y as strings when creating the function
            chartObj.xFunct = function(d){return d[xName]};

            // For each yObjs argument, create a yFunction
            function getYFn(column) {
                return function (d) {
                    return d[column];
                };
            }

            // Object instead of array
            chartObj.yFuncts = [];
            for (var y in yObjs) {
                yObjs[y].name = y;
                yObjs[y].yFunct = getYFn(yObjs[y].column);
                chartObj.yFuncts.push(yObjs[y].yFunct);
            }

            // Return the max of every yFunct
            chartObj.max = function (d) {
                return d3.max(chartObj.data, d);
            };

            // Create scale functions
            chartObj.xScale = d3.time.scale()
                .range([0, chartObj.width])
                .domain(d3.extent(chartObj.data, chartObj.xFunct));        

            chartObj.yScale = d3.scale.linear()
                .range([chartObj.height, 0])
                .domain([0, 120]);
            
            // Create axis
            chartObj.xAxis = d3.svg.axis()
                .scale(chartObj.xScale)
                .orient("bottom")
                .ticks(6)
                .tickSize(10)
                .tickFormat(d3.format(".0f")); 

            chartObj.yAxis = d3.svg.axis()
                .scale(chartObj.yScale)
                .orient("left")
                .tickSize(10); 

            //Formatter functions for the axes
            chartObj.xFormatter = d3.format(".0f");
            chartObj.yFormatter = d3.format(".2f");
            
            function dateFromDay(year, day) {
                var date = new Date(year, 0);
                var fulldate = new Date(date.setDate(day));
                return fulldate.toString().substring(0,15);
            }

            chartObj.bisectYear = d3.bisector(chartObj.xFunct).left; 

            // Build line building functions
            function getYScaleFn(yObj) {
                return function (d) {
                    return chartObj.yScale(yObjs[yObj].yFunct(d));
                };
            }
            
            for (var yObj in yObjs) {
                yObjs[yObj].line = d3.svg.line().interpolate("cardinal").x(function (d) {
                    return chartObj.xScale(chartObj.xFunct(d));
                }).y(getYScaleFn(yObj));
            }
            

            chartObj.svg;

            
            chartObj.bind = function (selector) {
                chartObj.mainDiv = d3.select(selector);
                // Add all the divs to make it centered and responsive
                chartObj.mainDiv.append("div")
                    .attr("class", "inner-wrapper")
                    .append("div")
                    .attr("class", "outer-box")
                    .append("div")
                    .attr("class", "inner-box");
                chartSelector = selector + " .inner-box";
                chartObj.chartDiv = d3.select(chartSelector);
                return chartObj;
            };

        // transition lines when clicking the legend
        function transitionLegend(legendId, legendWithSpaces){
            // are any other lines active?
            var linesActive = 0;
            activeArray = [];
            for (var y in yObjs) {
                if (yObjs[y].active){
                    linesActive += 1;
                    activeArray.push(y);
                }
            }

            if (linesActive === 5){
                for (var y in yObjs) {
                    if (y.replace(/\s+/g, '') !== legendId){
                        yObjs[y].tooltip.transition().duration(400)
                        .style("opacity", 0);
                        d3.select('#tag'+ y.replace(/\s+/g, '')).transition().duration(400)
                        .style("opacity", 0);
                        yObjs[y].active = false;
                    }
                }
            } else if (linesActive == 1 && activeArray[0].replace(/\s+/g, '') === legendId) {
                d3.selectAll('.line').transition().duration(400)
                    .style("opacity", 1);
                for (var y in yObjs) {
                    yObjs[y].tooltip.transition().duration(400)
                        .style("opacity", 1);
                    yObjs[y].active = true;
                }

            } else {
                var active = yObjs[legendWithSpaces].active;
                console.log(active);
                var newOpacity = active ? 0 : 1;
                 d3.select('#tag'+ legendId.replace(/\s+/g, ''))
                 .transition().duration(400)
                 .style("opacity", newOpacity);
                yObjs[legendWithSpaces].tooltip.transition().duration(400)
                    .style("opacity", newOpacity);
                yObjs[legendWithSpaces].active = !active;

            }
        };


            // Render the chart
            chartObj.render = function () {
                //Create SVG element
                chartObj.svg = chartObj.chartDiv.append("svg")
                    .attr("class", "chart-area")
                    .attr("width", chartObj.width + (chartObj.margin.left + chartObj.margin.right))
                    .attr("height", chartObj.height + (chartObj.margin.top + chartObj.margin.bottom))
                    .append("g")
                    .attr("transform", "translate(" + chartObj.margin.left + "," + chartObj.margin.top + ")");       

                // Draw Lines
                for (var y in yObjs) {
                    yObjs[y].path = chartObj.svg.append("path")
                        .datum(chartObj.data)
                        .attr("class", "line")
                        .style("stroke", color(y))
                        .attr("id", 'tag'+y.replace(/\s+/g, ''))
                        .attr("d", yObjs[y].line)
                        .attr("data-series", y)
                        .on("mouseover", function () {
                            focus.style("display", null);
                        })
                        .on("mouseout", function () {
                            focus.transition().delay(700).style("display", "none");
                        })
                        .on("mousemove", mousemove);
                        //console.log(y);
                }
                //console.log(yObjs["Late Aircraft Delay"]);

                // Draw Axis
                chartObj.svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + chartObj.height + ")")
                    .call(chartObj.xAxis)
                    .append("text")
                    .attr("class", "label")
                    .attr("x", chartObj.width / 2)
                    .attr("y", 30)
                    .attr("dx", "-1em")
                    .style("text-anchor", "middle")
                    .text(chartObj.xAxisLable);

                chartObj.svg.append("g")
                    .attr("class", "y axis")
                    .call(chartObj.yAxis)
                    .append("text")
                    .attr("class", "label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -42)
                    .attr("x", -chartObj.height / 2)
                    .attr("dy", "0em")
                    .style("text-anchor", "middle")
                    .text(chartObj.yAxisLable);


                //Draw legend
                var legend = chartObj.mainDiv.append('div').attr("class", "legend");
                for (var y  in yObjs) {
                    var series = legend.append('div').attr("id", y.replace(/\s+/g, '')).attr("data-series", y);
                    series.append('div')
                        .attr("class", "series-marker")
                        .style("background-color", color(y));                  
                    series.append('p').text(y);
                    yObjs[y].legend = series;
                    yObjs[y].active = true;
                    document.getElementById(y.replace(/\s+/g, ''))
                        .addEventListener("click", function(event){
                        transitionLegend(event.currentTarget.id, event.
                            currentTarget.getAttribute('data-series'));
                    });
                }  

                // transition lines when clicking the legend
                function transitionLegend(legendId, legendWithSpaces){
                    // are any other lines active?
                    var linesActive = 0;
                    activeArray = [];
                    for (var y in yObjs) {
                        if (yObjs[y].active){
                            linesActive += 1;
                            activeArray.push(y);
                        }
                    }

                    if (linesActive === 5){
                        for (var y in yObjs) {
                            if (y.replace(/\s+/g, '') !== legendId){
                                yObjs[y].tooltip.transition().duration(400)
                                .style("opacity", 0);
                                d3.select('#tag'+ y.replace(/\s+/g, '')).transition().duration(400)
                                .style("opacity", 0);
                                yObjs[y].active = false;
                            }
                        }
                    } else if (linesActive == 1 && activeArray[0].replace(/\s+/g, '') === legendId) {
                        d3.selectAll('.line').transition().duration(400)
                            .style("opacity", 1);
                        for (var y in yObjs) {
                            yObjs[y].tooltip.transition().duration(400)
                                .style("opacity", 1);
                            yObjs[y].active = true;
                        }

                    } else {
                        var active = yObjs[legendWithSpaces].active;
                        console.log(active);
                        var newOpacity = active ? 0 : 1;
                        d3.select('#tag'+ legendId.replace(/\s+/g, ''))
                        .transition().duration(400)
                        .style("opacity", newOpacity);
                        yObjs[legendWithSpaces].tooltip.transition().duration(400)
                            .style("opacity", newOpacity);
                        yObjs[legendWithSpaces].active = !active;

                    }
                };

                // Draw tooltips
                var focus = chartObj.svg.append("g")
                    .attr("class", "focus")
                    .style("display", "none");

                for (var y  in yObjs) {
                    yObjs[y].tooltip = focus.append("g");
                    yObjs[y].tooltip.append("circle")
                        .attr("r", 8);
                    yObjs[y].tooltip.append("rect")
                        .attr("x", 8)
                        .attr("y","-5")
                        .attr("width",22)
                        .attr("height",'1em');
                    yObjs[y].tooltip.append("text")
                        .attr("x", 9)
                        .attr("dy", ".35em");
                }

                // Date label
                focus.append("text")
                    .attr("class", "focus date")
                    .attr("x", 9)
                    .attr("y", 7);
                // Focus line
                focus.append("line")
                    .attr("class", "focus line")
                    .attr("y1", 0)
                    .attr("y2", chartObj.height);

                // Overlay to capture hover
                chartObj.svg.append("rect")
                    .attr("class", "overlay")
                    .attr("width", chartObj.width)
                    .attr("height", chartObj.height)
                    .on("mouseover", function () {
                        focus.style("display", null);
                    })
                    .on("mouseout", function () {
                        focus.style("display", "none");
                    })
                    .on("mousemove", mousemove);

                return chartObj;

                function mousemove() {
                    var x0 = chartObj.xScale.invert(d3.mouse(this)[0]), 
                        i = chartObj.bisectYear(dataset, x0, 1), 
                        d0 = chartObj.data[i - 1], d1 = chartObj.data[i];
                    try {
                        var d = x0 - chartObj.xFunct(d0) > chartObj.xFunct(d1) - x0 ? d1 : d0;
                    } catch (e) { return;}
                    minY = chartObj.height;
                    for (var y  in yObjs) {
                        yObjs[y].tooltip
                            .attr("transform", "translate(" + chartObj.xScale(chartObj.xFunct(d)) + "," + chartObj.yScale(yObjs[y].yFunct(d)) + ")");
                        yObjs[y].tooltip
                            .select("text")
                            .text(chartObj.yFormatter(yObjs[y].yFunct(d)));
                        minY = Math.min(minY, chartObj.yScale(yObjs[y].yFunct(d)));
                    }

                    focus.select(".focus.line")
                        .attr("transform", "translate(" + chartObj.xScale(chartObj.xFunct(d)) + ")")
                        .attr("y1", minY);
                    focus.select(".focus.date")
                        //.text("Date: " + chartObj.yFormatter(chartObj.xFunct(d)));
                        .text(" Date: " + dateFromDay(d.Year, chartObj.xFunct(d)));
                }
                
            };
            return chartObj;
        };
    

</script>

</html>